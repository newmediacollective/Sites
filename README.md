# Sites
A set of tools to manage photo stream sites.

In a few minutes you can have your own responsive, HTTPS site and the ability to post photos from anywhere.

Here's [my site](https://christianbator.com) managed with these tools.

## Getting Started
Follow along with the instructions below, and your site should be up in no time.

### Prerequisites
* Python3 and ImageMagick installed locally
```
brew install python
brew install imagemagick
```
* A domain name (e.g. google.com), which we'll call `{host}`
  * I like [namecheap](https://www.namecheap.com)
* An Ubuntu 18.04 server with ssh access to `root`
  * You can set one up through [DigitalOcean](https://www.digitalocean.com/docs/droplets/how-to/create/)
* DNS configured to point the domain to the server
  * You can follow [these instructions](https://www.digitalocean.com/community/tutorials/how-to-point-to-digitalocean-nameservers-from-common-domain-registrars)

Verify your domain points to your ip with:
```
nslookup {host}
```

### Setup
Setup your server with the following commands, substituting your domain for `{host}`:

**1. Clone the repo**
```
git clone git@github.com:christianbator/Sites.git
cd Sites
```

**2. Configure your local environment**
```
source scripts/setup_local.sh
```

* This will create a virtual environment in `app/.env`
  * All `python` commands should be run with your virtual environment activated
  * Activate with `source app/.env/bin/activate`
  * Deactivate with `deactivate`

**3. Configure your remote environment**
Create a user named `webhost` with `sudo` privileges:
```
ssh root@{host} "bash -s" -- < scripts/setup_webhost.sh
```

Configure the server:
```
ssh webhost@{host}
git clone git@github.com:christianbator/Sites.git
cd Sites
source scripts/setup_server.sh
```

* This will create a virtual environment in `app/.env`
  * All `python` commands should be run with your virtual environment activated
  * Activate with `source app/.env/bin/activate`
  * Deactivate with `deactivate`
* This will also setup [nginx](https://www.nginx.com/resources/wiki/) and [Let's Encrypt](https://letsencrypt.org)
* Everything will be run from the `webhost` user as part of the nginx group, `www-data`

**4. Create your site**
```
python app/site_manager.py create -s "{host}" -t "site title" -d "site description"
```

* This will create the directory `app/.sites/{host}` that contains all your site's data
* It will also generate a secret key in `app/.sites/secret.txt` that we'll use to sign tokens
  * To post to your site, you'll need to provide a valid token (more on that later)
* You can update your site's title and description in the `app/.sites/{host}/data/properties.json` file

**5. Encrypt the traffic**
```
sudo certbot --nginx -d {host} -d www.{host}
```

We'll update the nginx config, so as long as you successfully create a certificate, the other prompts don't matter.

**6. Start it up**
Update the nginx config in `/etc/nginx/nginx.conf` for every site defined in `app/.sites`:
```
sudo python3 app/site_manager.py update_nginx
```

Start nginx (to serve the static site) and a gunicorn daemon (to serve the flask app for image uploads):
```
./scripts/start_services.sh
```

You should see an empty site with your title and description at https://{host}

### Setup Notes
* Site
  * The site is served as static content from nginx out of the `/home/webhost/Sites/app/.sites/{host}/content` directory
  * Site data is stored in `app/.sites/{host}/data`
  * HTML pages are generated by the `app/content_manager.py` script
* Posting
  * Image uploads are handled by a Flask app served by a Gunicorn daemon
  * Images should be uploaded as a common type (png, jpg, etc.)
  * Images are then converted to progressive jpgs using ImageMagick
* Routing
  * All HTTP traffic is redirected to HTTPS
  * All www urls are redirected to non www
  * All trailing slash urls are rewritten to non trailing slash urls

## Usage
There are a few tools to help manage your site - you can even manage multiple sites, but they must be hosted on the same server.

### Syncing
You can sync your site content to and from your remote server with:
```
./scripts/pull.sh {host}
./scripts/push.sh {host}
```

These scripts just `rsync` the `app/.sites/{host}` directory to and from the remote server. Pulling is useful when you've posted an image directly to your remote server, and you want to pull the latest version of your site to your local machine. Pushing is useful when you've posted an image on your local machine and want to update your public site.

**Note:** this will overwrite the destination site!

You can also sync the secret key with:
```
./scripts/pull_secret.sh {host}
./scripts/push_secret.sh {host}
```

**Note:** for now, there is only one secret shared across all sites on the same server.

### Running Locally
To run the app locally in debug mode, use:
```
python app/app.py
```

This will run the app at `http://localhost:5000`, so you can post images locally.

You can open your site locally with:
```
open app/.sites/{host}/content/views/index.html
```

### Posting
To post locally in debug mode, use:
```
./scripts/post_local.sh {host} /path/to/image.jpg "caption"
```

To post to your server, first pull the secret if you don't have it in `app/.sites/secret.txt`:
```
./scripts/pull_secret.sh {host}
```

Then verify we can create a token from it:
```
pyjwt --key=$(cat app/.sites/secret.txt) encode sitename={host}
```

Then you can use the helper script to post images:
```
./scripts/post.sh {host} /path/to/image.jpg "caption"
```

Under the hood, it's just an HTTP POST request to `https://{host}/posts`, meaning you can use that token to post images from anywhere:
```
curl -i -H "Authorization: Bearer token" -F "image=@/path/to/image" -F "caption=caption" https://{host}/posts
```

### Icons
Fill in the `app/.sites/{host}/content/icons` directory with the following files so your site will automatically serve a favicon and apple touch icon:
```
icon.png (64x64)
apple-touch-icon.png (180x180)
```

Then push your site to your remote server:
```
./scripts/push.sh {host}
```

### Regenerating
If you ever edit anything in `app/.sites/{host}/data`, you can regenerate your site with:
```
python app/content_manager.py regenerate -s {host}
```

### Multiple Sites
Managing multiple sites on the same machine is pretty simple.

**1. Create a new site on your server**
```
python app/site_manager.py create -s "{new_host}" -t "new site title" -d "new site description"
```

**2. Encrypt the traffic**
```
sudo certbot --nginx -d {new_host} -d www.{new_host}
```

**3. Update and restart nginx**
```
sudo python3 app/site_manager.py update_nginx
sudo systemctl restart nginx
```

## Mobile Uploads
As mentioned above, posting a photo is just an HTTP POST request, so you can post from anywhere.

### iOS
I made an iOS shortcut that you can use to post from your iPhone:

* Enable shortcut sharing: Settings > Shortcuts > Allow Untrusted Shortcuts
* Download [the shortcut](https://www.icloud.com/shortcuts/2517d7a649e541289d09ba00c86c05f3)
* Get your sites and tokens with:
```
python scripts/ios_shortcut_input.py
```
* Paste the result into the shortcut configuration when prompted

You should be able to run the shortcut and select a photo to post, and it will also appear as a share sheet option.

### Android
Buy a [real phone](https://www.apple.com/iphone/) ;)

Open to submissions!

## Caveats
The site design is simple and inflexible, but there are already plenty of tools for managing complex sites. I wanted to post photos to an https site from my laptop and phone, and I wanted to serve them as static content.

That said, feel free to fork the project and mess around with the `template` directory - there are css files in `template/content/styles`. Restructuring the HTML requires code changes in `app/post.py`.

Happy site building!
